# Настройка SendGrid для отправки писем

Для обеспечения функционала сброса пароля и отправки приветственных писем, необходимо настроить SendGrid и верифицировать email отправителя.

## Шаги по настройке SendGrid

### 1. Создание учетной записи в SendGrid

1. Перейдите на сайт [SendGrid](https://sendgrid.com/) и создайте учетную запись.
2. После регистрации, войдите в панель управления SendGrid.

### 2. Получение API ключа

1. В панели управления SendGrid перейдите в раздел **Settings** > **API Keys**.
2. Нажмите кнопку **Create API Key**.
3. Укажите имя ключа (например, "Dombyra Email Service").
4. Выберите уровень доступа "Full Access" или "Restricted Access" с разрешениями на отправку писем.
5. Нажмите **Create & View**.
6. Скопируйте сгенерированный API ключ и сохраните его в безопасном месте.

### 3. Верификация адреса отправителя

Для отправки писем через SendGrid необходимо верифицировать адрес отправителя. Есть два способа:

#### А. Верификация отдельного адреса email (Single Sender Verification)

1. В панели управления SendGrid перейдите в **Settings** > **Sender Authentication**.
2. Нажмите кнопку **Verify a Single Sender**.
3. Заполните форму:
   - **From Name** - имя отправителя, которое будет отображаться у получателей
   - **From Email Address** - email адрес отправителя (например, noreply@dombra-master.kz)
   - **Reply To** - адрес для ответов
   - **Company Address, City, State, Zip Code, Country** - физический адрес вашей компании
   - **Nickname** - внутреннее название для идентификации этого отправителя
4. Нажмите кнопку **Create**.
5. На указанный email придет письмо для подтверждения. Перейдите по ссылке из письма для завершения верификации.

#### Б. Верификация домена (Domain Authentication) - рекомендуемый метод для production

1. В панели управления SendGrid перейдите в **Settings** > **Sender Authentication**.
2. Нажмите кнопку **Authenticate Your Domain**.
3. Введите имя вашего домена (например, dombra-master.kz) и нажмите **Next**.
4. Выберите опцию для настройки DKIM (рекомендуется выбрать 2048 bit DKIM).
5. Вы получите DNS-записи, которые необходимо добавить в настройки вашего домена:
   - CNAME запись для верификации домена
   - CNAME записи для DKIM
   - MX записи для входящей почты (если планируете использовать SendGrid для приема почты)
6. Добавьте эти записи в DNS-настройки вашего домена через вашего DNS-провайдера.
7. Вернитесь в SendGrid и нажмите **Verify** для проверки настроек.
8. После успешной верификации вы сможете использовать любой email-адрес с этим доменом в качестве отправителя.

### 4. Обновление переменных окружения

#### На локальном сервере:

Обновите файл `.env` в директории backend:

```
SENDGRID_API_KEY=ваш_api_ключ_sendgrid
SENDGRID_FROM_EMAIL=noreply@dombra-master.kz
```

#### На Railway:

1. Войдите в свой проект на Railway.
2. Перейдите в раздел **Variables**.
3. Добавьте или обновите следующие переменные:
   - `SENDGRID_API_KEY`=ваш*api*ключ_sendgrid
   - `SENDGRID_FROM_EMAIL`=noreply@dombra-master.kz

#### На Vercel:

1. Войдите в панель управления Vercel.
2. Выберите ваш проект.
3. Перейдите в **Settings** > **Environment Variables**.
4. Добавьте переменную `NEXT_PUBLIC_API_URL` с URL вашего backend API.

### 5. Тестирование отправки писем

1. Перейдите на страницу восстановления пароля в вашем приложении.
2. Введите email, на который хотите получить письмо для сброса пароля.
3. Проверьте, что письмо успешно доставлено.
4. Если письмо не пришло, проверьте логи на Railway для диагностики проблемы.

## Примечания по безопасности

1. Никогда не публикуйте API ключ SendGrid в публичных репозиториях.
2. Регулярно обновляйте API ключ для повышения безопасности.
3. Используйте шифрование переменных окружения на production серверах.

## Шаблоны писем

В коде используются два типа писем:

- Приветственное письмо при регистрации (функция `sendWelcomeEmail`)
- Письмо для сброса пароля (функция `sendPasswordResetEmail`)

Эти шаблоны можно редактировать в файле `backend/services/emailService.js` для настройки дизайна и текста писем.
